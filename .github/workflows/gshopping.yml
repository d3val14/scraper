name: Google Shopping Scraper

on:
  workflow_dispatch:
    inputs:
      input_filename:
        description: "Input CSV filename on FTP"
        required: true
        default: "google_shopping.csv"
      total_chunks:
        description: "Number of chunks"
        required: true
        default: "4"

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.gen.outputs.matrix }}
    steps:
      - id: gen
        run: |
          TOTAL=${{ github.event.inputs.total_chunks }}

          MATRIX="["
          for ((i=1;i<=TOTAL;i++)); do
            MATRIX+="{\"chunk_id\":$i},"
          done
          MATRIX="${MATRIX%,}]"

          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"

  scrape:
    needs: plan
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.plan.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            google-chrome-stable \
            chromium-chromedriver \
            xvfb \
            lftp

      - name: Install python deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas==2.1.4

      - name: Run scraper
        env:
          DISPLAY: :99
        run: |
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 3

          python gshopping/gscrapperci.py \
            --chunk-id ${{ matrix.chunk_id }} \
            --total-chunks ${{ github.event.inputs.total_chunks }} \
            --input-file "${{ github.event.inputs.input_filename }}"

      - name: Upload chunk output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: chunk-${{ matrix.chunk_id }}
          path: output/

  merge:
    needs: scrape
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install pandas
        run: |
          python -m pip install --upgrade pip
          pip install pandas==2.1.4

      - name: Download chunks
        uses: actions/download-artifact@v4
        with:
          path: chunks

      - name: Merge CSV files
        run: |
          python scripts/merge_results.py

      - name: Upload merged CSVs to FTP
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASS }}
          FTP_PATH: ${{ secrets.FTP_PATH }}
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y lftp

          for file in merged_products_*.csv merged_sellers_*.csv; do
            [ -f "$file" ] || continue
            echo "Uploading $file"

            lftp -u "$FTP_USER","$FTP_PASS" "$FTP_HOST" -e "
              set ftp:ssl-allow no
              mkdir -p $FTP_PATH
              cd $FTP_PATH
              put $file
              bye
            "
          done